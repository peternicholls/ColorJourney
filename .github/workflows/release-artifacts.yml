name: Release Artifacts

# Triggered when a release tag (X.Y.Z) is pushed to main
on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

# Restrict permissions for security
permissions:
  contents: write # For creating releases
  packages: read # For downloading dependencies

jobs:
  preflight:
    name: "Preflight: tag and branch validation"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4.1.7
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Verify tag format and branch alignment
        run: |
          if [[ ! "${GITHUB_REF}" =~ ^refs/tags/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid tag format. Expected X.Y.Z (without 'v' prefix)"
            exit 1
          fi

          git fetch --no-tags origin main

          TAG_COMMIT=$(git rev-parse HEAD)
          MAIN_HEAD=$(git rev-parse origin/main)

          echo "Tag commit:  ${TAG_COMMIT}"
          echo "origin/main: ${MAIN_HEAD}"

          if [ "${TAG_COMMIT}" != "${MAIN_HEAD}" ]; then
            echo "ERROR: Release tags must point to the tip of origin/main."
            exit 1
          fi

          echo "✓ Tag format valid and aligned to origin/main"

  package-release:
    name: Package Release (tar.gz and zip)
    runs-on: macos-latest
    needs: preflight

    steps:
      - uses: actions/checkout@v4.1.7
        with:
          ref: ${{ github.ref }}
          persist-credentials: false

      - name: Validate release package contents
        run: |
          echo "Validating release package contents..."

          # MANDATORY: Both Swift wrapper and C core MUST be included
          if [ ! -d "Sources/ColorJourney" ]; then
            echo "ERROR: Swift wrapper (Sources/ColorJourney/) is missing!"
            exit 1
          fi

          if [ ! -d "Sources/CColorJourney" ]; then
            echo "ERROR: C core (Sources/CColorJourney/) is missing! Release package must include C core for API functionality."
            exit 1
          fi

          # Warn about excluded items
          if [ -d "DevDocs" ]; then
            echo "ℹ DevDocs will be excluded from release package"
          fi

          # Check for sensitive files
          if find . -type f \( -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name ".env" \) | grep -q .; then
              echo "ERROR: Sensitive files detected!"
              exit 1
          fi

          echo "✓ Release package validation passed"

      - name: Create tar.gz archive
        id: tar-artifact
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          ARTIFACT_NAME="ColorJourney-${VERSION}"

          # Create archive with Swift wrapper + C core + essentials
          tar --exclude=DevDocs \
              --exclude='.git*' \
              --exclude='.github' \
              --exclude='Makefile*' \
              --exclude='Dockerfile*' \
              --exclude='docker-compose.yml' \
              --exclude='scripts' \
              --exclude='*.xcodeproj' \
              --exclude='*.key' \
              --exclude='*.pem' \
              --exclude='.env*' \
              --exclude='*.backup*' \
              -czf "${ARTIFACT_NAME}.tar.gz" \
              Sources/ColorJourney/ \
              Sources/CColorJourney/ \
              Package.swift \
              README.md \
              LICENSE \
              CHANGELOG.md \
              Docs/

          echo "artifact=${ARTIFACT_NAME}.tar.gz" >> $GITHUB_OUTPUT
          echo "✓ tar.gz archive created: ${ARTIFACT_NAME}.tar.gz"

      - name: Create zip archive
        id: zip-artifact
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          ARTIFACT_NAME="ColorJourney-${VERSION}"

          # Create zip with Swift wrapper + C core + essentials
          zip -r "${ARTIFACT_NAME}.zip" \
              Sources/ColorJourney/ \
              Sources/CColorJourney/ \
              Package.swift \
              README.md \
              LICENSE \
              CHANGELOG.md \
              Docs/ \
              -x "DevDocs/*" \
              ".git*" \
              ".github/*" \
              "Makefile*" \
              "Dockerfile*" \
              "docker-compose.yml" \
              "scripts/*" \
              "*.xcodeproj/*" \
              "*.key" \
              "*.pem" \
              ".env*" \
              "*.backup*"

          echo "artifact=${ARTIFACT_NAME}.zip" >> $GITHUB_OUTPUT
          echo "✓ zip archive created: ${ARTIFACT_NAME}.zip"

      - name: Verify C core is in both archives
        run: |
          TAR_ARCHIVE="${{ steps.tar-artifact.outputs.artifact }}"
          ZIP_ARCHIVE="${{ steps.zip-artifact.outputs.artifact }}"

          echo "Verifying tar.gz contains C core..."
          if tar -tzf "${TAR_ARCHIVE}" | grep -q "Sources/CColorJourney/"; then
            echo "✓ C core found in tar.gz"
          else
            echo "ERROR: C core NOT found in tar.gz!"
            exit 1
          fi

          echo "Verifying zip contains C core..."
          if unzip -l "${ZIP_ARCHIVE}" | grep -q "Sources/CColorJourney/"; then
            echo "✓ C core found in zip"
          else
            echo "ERROR: C core NOT found in zip!"
            exit 1
          fi

      - name: Audit release artifacts
        run: |
          chmod +x scripts/audit-artifacts.sh
          ./scripts/audit-artifacts.sh "${{ steps.tar-artifact.outputs.artifact }}" unified
          ./scripts/audit-artifacts.sh "${{ steps.zip-artifact.outputs.artifact }}" unified

      - name: Calculate artifact hashes
        id: hashes
        run: |
          TAR_HASH=$(shasum -a 256 "${{ steps.tar-artifact.outputs.artifact }}" | awk '{print $1}')
          ZIP_HASH=$(shasum -a 256 "${{ steps.zip-artifact.outputs.artifact }}" | awk '{print $1}')

          echo "tar_hash=${TAR_HASH}" >> $GITHUB_OUTPUT
          echo "zip_hash=${ZIP_HASH}" >> $GITHUB_OUTPUT

          echo "tar.gz SHA256: ${TAR_HASH}"
          echo "zip SHA256: ${ZIP_HASH}"

          # Write checksums file
          {
            echo "${TAR_HASH}  ${{ steps.tar-artifact.outputs.artifact }}"
            echo "${ZIP_HASH}  ${{ steps.zip-artifact.outputs.artifact }}"
          } > checksums.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            ${{ steps.tar-artifact.outputs.artifact }}
            ${{ steps.zip-artifact.outputs.artifact }}
            checksums.txt
          retention-days: 7

  publish-release:
    name: Publish Release to GitHub
    needs: package-release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4.1.7

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Extract release notes from CHANGELOG
        run: |
          # Extract version from tag (e.g., 1.0.1)
          VERSION=${GITHUB_REF#refs/tags/}

          # Extract the section for this release from CHANGELOG.md
          # Finds the section starting with ## [VERSION] and stops at the next ## or EOF
          awk -v version="$VERSION" '
            /^## \['"${VERSION}"'\]/ { found=1; next }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md > release-notes.md

          # Prepend a brief header with link to full CHANGELOG
          {
            echo "See [CHANGELOG.md](https://github.com/peternicholls/ColorJourney/blob/main/CHANGELOG.md) for full release history."
            echo ""
            cat release-notes.md
          } > release-notes-final.md

          echo "Generated release notes:"
          cat release-notes-final.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release-artifacts/ColorJourney-*.tar.gz
            release-artifacts/ColorJourney-*.zip
            release-artifacts/checksums.txt
          body_path: release-notes-final.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
